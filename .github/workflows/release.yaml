name: Release

on:
  workflow_dispatch:
  release:
    types: [created]
  push:
    branches:
      - fix/github-workflow

permissions:
  contents: read

jobs:
  # Build job to create the binaries using our Makefile
  build:
    runs-on: ubuntu-24.04
    name: Build binaries
    outputs:
      digests: ${{ steps.hash.outputs.digests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          check-latest: true
      
      - name: Build cross-platform binaries
        run: |
          make release
      
      - name: List built artifacts
        run: ls -la dist/
        
      - name: Generate artifacts hash
        id: hash
        run: |
          # Generate hash information
          cd dist
          echo "digests=$(sha256sum mock-harbor-* | base64 -w0)" >> $GITHUB_OUTPUT
      
      - name: Get short SHA
        id: sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Upload artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v0.1.0-${{ steps.sha.outputs.sha }}
          name: Release v0.1.0-${{ steps.sha.outputs.sha }}
          files: |
            dist/mock-harbor-darwin-amd64
            dist/mock-harbor-darwin-arm64
            dist/mock-harbor-linux-amd64
            dist/mock-harbor-linux-arm64
            dist/SHA256SUMS
          generate_release_notes: true
